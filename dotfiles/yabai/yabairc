#!/usr/bin/env sh

yabai -m config \
  top_padding 5 \
  bottom_padding 5 \
  left_padding 5 \
  right_padding 5 \
  window_zoom_persist on \
  window_shadow on \
  window_gap 10 \
  window_animation_duration 0.0 \
  window_animation_easing ease_out_circ \
  window_opacity_duration 0.0 \
  window_opacity on \
  active_window_opacity 1.0 \
  normal_window_opacity 0.98 \
  mouse_modifier fn \
  mouse_action1 move \
  mouse_action2 resize \
  external_bar all:32:0 \
  mouse_drop_action stack \
  layout stack

# Default space layouts (will be overridden by apply_setup.sh based on display config)
# Space 1 (dev):      stack (laptop) or bsp (external monitor)
# Space 2 (terminal): stack
# Space 3 (social):   stack
# Space 4 (work):     stack
# Space 5 (other):    stack (multi-monitor only)
yabai -m space 1 --layout stack
yabai -m space 2 --layout stack
yabai -m space 3 --layout stack
yabai -m space 4 --layout stack
yabai -m space 5 --layout stack 2>/dev/null || true

# Signal helper functions
add_sketchybar_signal() {
    yabai -m signal --add event="$1" action="command -v sketchybar &> /dev/null && sketchybar --trigger $2"
}

add_app_focus_signal() {
    yabai -m signal --add app="^$1$" event="$2" action='yabai -m space --focus next; sleep 0.01; yabai -m space --focus prev'
}

add_display_signal() {
    yabai -m signal --add event="$1" action="sleep 3 && ~/.config/yabai/apply_setup.sh auto"
}

# Sketchybar signals (only the ones we actually use)
SKETCHYBAR_SIGNALS=(
    "window_focused:window_focus"
    "application_front_switched:front_app_switched"
    "space_changed:space_change"
)

for signal in "${SKETCHYBAR_SIGNALS[@]}"; do
    event="${signal%:*}"
    trigger="${signal#*:}"
    add_sketchybar_signal "$event" "$trigger"
done

# App focus refresh signals
APP_FOCUS_APPS=("Ghostty" "Finder")
APP_FOCUS_EVENTS=("window_created" "window_destroyed")

for app in "${APP_FOCUS_APPS[@]}"; do
    for event in "${APP_FOCUS_EVENTS[@]}"; do
        add_app_focus_signal "$app" "$event"
    done
done

# Display change signals
DISPLAY_EVENTS=("display_added" "display_removed")
for event in "${DISPLAY_EVENTS[@]}"; do
    add_display_signal "$event"
done

# Rules
yabai -m rule --add app="^(System Preferences|1Password|^Steam$)$" manage=off
yabai -m rule --add app="^Spotify$" scratchpad=spotify grid=11:11:1:1:9:9
yabai -m rule --add app="^Discord$" title!="^Discord Updater$" scratchpad=discord grid=11:11:1:1:9:9
yabai -m rule --apply # https://github.com/koekeishiya/yabai/issues/2178

command -v sketchybar &> /dev/null && sketchybar --trigger yabai_loaded

# Apply workspace setup (auto-detects display configuration)
# This also handles space labeling internally
~/.config/yabai/apply_setup.sh auto

echo "yabai configuration loaded.."
osascript -e "display notification \"yabai configuration loaded..!\" with title \"yabai\""
